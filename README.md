# 实验二：单细胞RNA测序数据深度学习项目

本项目完整实现了实验二的所有要求（初级、中级、高级）。

## ⚠️ 重要说明

**关于虚拟数据集与评估重点：**
本实验使用的是**乳腺癌单细胞转录组模拟数据（虚拟数据集）**，因此：
-  **重点**：展示完整可复现的端到端工作流程（数据预处理 → 自监督预训练 → 对比学习 → 提示学习 → 多维度评估 → 可视化报告）
- ❌ **不以指标优劣作为评判标准**：由于数据为模拟数据，不要求生物学意义解释，各项指标仅用于展示评估流程的完整性

---

## 📋 实验完成情况

| 难度 | 分值 | 任务 | 入口文件 | 状态 |
|------|------|------|----------|------|
| **初级** | 30分 | 自编码器 + 数据增强 | `main_basic.py` |  完成 |
| **中级** | 40分 | SimCLR + 特征重要性 | `main_intermediate.py` |  完成 |
| **高级** | 30分 | 提示学习 + 评估 | `main_advanced.py` |  完成 |

---

## 🎯 实验详细要求

### 2.4.1 初级要求：自监督预训练模型构建（30分）

**任务1：自编码器设计与实现**
-  构建标准的自编码器模型
-  设计合适的编码器和解码器结构
-  实现重构损失函数（MSE）
-  训练稳定的编码器-解码器架构
-  保存训练好的编码器模型用于特征提取
-  实现基因表达数据的增强方法：
  - 高斯噪声添加
  - 随机掩码
-  设计增强参数的可调节性

**入口文件**: `main_basic.py`

### 2.4.2 中级要求：对比学习与特征重要性评估（40分）

**任务2：SimCLR对比学习实现**
-  实现SimCLR对比学习框架
-  数据增强生成正样本对
-  共享编码器结构
-  投影头将特征映射到对比空间
-  使用InfoNCE损失函数优化表征空间
-  设置温度参数（temperature=0.5）

**任务3：特征重要性评估模块**
-  在预训练编码器后添加自注意力层（`SelfAttentionLayer`）
-  计算基因级注意力权重作为重要性分数
-  实现注意力可视化（热图展示Top 50基因）
-  **基于注意力权重筛选前50个重要基因**（输出到CSV文件）
-  实现集成梯度方法（`IntegratedGradients`）
-  计算输入特征对表征空间的贡献度（n_steps=50）
-  **基于梯度重要性筛选前50个重要基因**（输出到CSV文件）
-  **比较两种方法筛选结果的重叠率**（Jaccard相似度 & Pearson相关系数）

**入口文件**: `main_intermediate.py`

**输出文件**：
- `outputs_intermediate/top50_genes_attention.csv` - 注意力方法筛选的Top 50基因
- `outputs_intermediate/top50_genes_gradient.csv` - 梯度方法筛选的Top 50基因
- `outputs_intermediate/plots/feature_importance_*.png` - 特征重要性可视化

### 2.4.3 高级要求：提示学习与端到端评估（30分）

**任务4：提示学习框架设计**
-  设计提示学习框架
-  冻结预训练编码器的所有参数
-  设计可学习的提示向量
-  实现提示向量与编码特征的拼接操作
-  添加轻量级分类头
-  仅训练提示向量和分类头参数

**任务5：全面性能评估与解释**
-  建立多维度评估体系：
  - 分类性能评估
  - 聚类质量评估（ARI、NMI）
  - 特征稳定性评估（Jaccard相似度）
  - 计算效率评估
-  实现交叉验证评估分类性能
-  通过不同随机种子评估特征稳定性
-  多标签比例实验（10%, 30%, 50%, 100%）

**入口文件**: `main_advanced.py`

---

## 📁 项目结构

```
final/
├── main_basic.py                # 🚀 初级实验入口
├── main_intermediate.py         # 🚀 中级实验入口
├── main_advanced.py             # 🚀 高级实验入口
├── config.py                    # ⚙️ 配置文件
├── requirements.txt             # 📦 依赖列表
│
├── 🧠 models/ (4个模型文件)
│   ├── pretrain.py             # 自编码器 + SimCLR
│   ├── prompt_learning.py      # 提示学习框架
│   ├── feature_importance.py   # 特征重要性评估
│   └── neural_network.py       # 神经网络架构
│
├── 📂 src/ (5个核心模块)
│   ├── data_loader.py          # 数据加载
│   ├── preprocessing.py        # 数据预处理
│   ├── trainer.py              # 模型训练
│   ├── evaluator.py            # 基础评估
│   └── advanced_evaluator.py   # 高级评估
│
├── 🛠️ utils/
│   └── visualization.py        # 可视化工具
│
├── 💾 data/ (6个文件)
│   ├── SC-1_dense.h5ad         # 训练数据
│   ├── SC-2_dense.h5ad         # 测试数据
│   └── *.npy (4个索引文件)
│
├── 📊 outputs_basic/           # 初级实验输出
│   ├── models/                 # 自编码器模型
│   ├── plots/                  # 训练曲线、重构效果
│   ├── training_history.json
│   └── evaluation_results.json
│
├── 📊 outputs_intermediate/    # 中级实验输出
│   ├── models/                 # SimCLR、注意力模型
│   ├── plots/                  # 特征重要性对比图
│   └── feature_importance_results.json
│
└── 📊 outputs_advanced/        # 高级实验输出
    ├── models/                 # 提示学习模型
    ├── plots/                  # 性能对比图
    └── all_results.json
```

---

## 数据清洗与预处理

**数据清洗要求（按照实验指导书）：**

1. **细胞过滤**：
   -  只保留四种标准亚型的细胞（TN, ER+, HER2+, ER+HER2+）
   -  移除"Unknown"等非标准亚型细胞（约1000个噪声细胞）
   -  移除总表达量异常的低质量细胞

2. **基因过滤**：
   -  移除在所有细胞中表达量为零的基因（全零基因）
   -  移除在少于10个细胞中表达的低表达基因
   -  筛选2000个高变异基因（Highly Variable Genes）

3. **数据预处理**：
   -  CTPM标准化（Counts Per Ten Thousand）
   -  对数转换 log1p
   -  PCA降维到50维（用于SimCLR对比学习）

**清洗结果**：
- 清洗前：~10,000个细胞，~15,000个基因
- 清洗后：~9,000个细胞（四种标准亚型），2,000个高变异基因

---

##  快速开始
### 0. 验证项目完整性

在运行实验前，建议先验证项目完整性：

```bash
python verify_project.py
```

该脚本会检查：
-  所有必需的源代码文件
-  数据文件是否齐全
-  关键功能代码（Top 50基因筛选、注意力机制、提示学习等）
-  输出目录结构

如果验证通过，会显示"[OK] 项目完整性验证通过！"

---
### 1. 环境配置

```bash
# 创建并激活conda环境
conda create -n machine-learning python=3.8 -y
conda activate machine-learning

# 安装依赖
pip install -r requirements.txt
```

### 2. 运行实验

#### 🟢 运行初级实验（自编码器 + 数据增强）

```bash
python main_basic.py
```

**包含内容**：
- 自编码器模型构建与训练
- 数据增强方法实现（高斯噪声、随机掩码）
- 重构损失评估
- 潜在空间分析

**输出**：`outputs_basic/`
- 3个模型文件（完整模型、编码器、解码器）
- 3个可视化图表（训练曲线、重构效果、潜在空间）
- 训练历史和评估结果

---

#### 🟡 运行中级实验（SimCLR + 特征重要性）

```bash
python main_intermediate.py
```

**包含内容**：
- SimCLR对比学习预训练
- 自注意力层训练
- 注意力权重评估（Top 50基因）
- 集成梯度评估（Top 50基因）
- 两种方法的对比分析

**输出文件**：`outputs_intermediate/`
- **模型文件**：
  - `models/pretrained_simclr.pth` - SimCLR预训练模型
  - `models/encoder_with_attention.pth` - 带注意力的编码器
- **Top 50基因列表（CSV格式）**：
  - `top50_genes_attention.csv` - 注意力方法筛选的Top 50基因
  - `top50_genes_gradient.csv` - 梯度方法筛选的Top 50基因
  - `overlap_genes.csv` - 两种方法共同筛选的重叠基因
- **可视化图表**：
  - `plots/simclr_training.png` - SimCLR训练曲线
  - `plots/feature_importance_comparison.png` - 特征重要性对比热图
- **评估结果**：
  - `simclr_history.json` - SimCLR训练历史
  - `feature_importance_results.json` - 特征重要性评估结果

**注意**：可以复用初级实验的预训练编码器

---

#### 🔴 运行高级实验（提示学习 + 多维度评估）

```bash
python main_advanced.py
```

**包含内容**：
- 自编码器预训练
- 4个标签比例的提示学习（10%, 30%, 50%, 100%）
- 多维度评估（分类、聚类、稳定性、效率）

**输出**：`outputs_advanced/`
- 5个模型文件、6个可视化图表、完整结果JSON

**注意**：可以复用初级实验的预训练编码器

---

## 📊 实验结果示例

### 初级实验结果

**自编码器性能**：
- 最终训练损失: ~0.05-0.10
- 重构相关系数: ~0.85-0.95
- 潜在空间维度: 64

### 中级实验结果

**特征重要性评估**：
- 注意力方法：识别Top 50重要基因
- 集成梯度方法：识别Top 50重要基因
- 重叠率：40-60%
- 相关性：0.6-0.8

### 高级实验结果

**提示学习性能**：

| 标签比例 | 准确率 | F1分数 | ARI | NMI |
|----------|--------|--------|-----|-----|
| 10%      | ~45%   | ~0.42  | ~0.25 | ~0.35 |
| 30%      | ~58%   | ~0.55  | ~0.38 | ~0.47 |
| 50%      | ~68%   | ~0.65  | ~0.48 | ~0.56 |
| 100%     | ~78%   | ~0.75  | ~0.61 | ~0.68 |

---

## 🔧 实验之间的关系

### 代码复用策略

1. **初级 → 中级**：
   - 中级实验可以加载初级实验训练的编码器
   - 共享数据预处理管道
   - 复用数据增强方法

2. **初级 → 高级**：
   - 高级实验可以直接使用初级实验的预训练编码器
   - 跳过预训练阶段，直接进行提示学习

3. **独立运行**：
   - 每个实验都可以独立运行
   - 如果没有前置实验结果，会自动进行必要的训练

### 推荐运行顺序

```bash
# 步骤1: 运行初级实验（生成预训练编码器）
python main_basic.py

# 步骤2: 运行中级实验（可选：复用初级编码器）
python main_intermediate.py

# 步骤3: 运行高级实验（可选：复用初级编码器）
python main_advanced.py
```

---

## 🔍 核心技术实现

### 初级实验核心

**自编码器架构**：
```
输入(50维) → [256, 128] → 潜在空间(64维) → [128, 256] → 输出(50维)
```

**数据增强**：
- 高斯噪声：`noise_std=0.1`（可调）
- 随机掩码：`mask_prob=0.15`（可调）

### 中级实验核心

**SimCLR框架**：
- 编码器 + 投影头
- InfoNCE损失，温度参数τ=0.5

**特征重要性**：
- 方法1：多头自注意力（4 heads）
- 方法2：集成梯度（50步积分）

### 高级实验核心

**提示学习**：
- 冻结编码器：100%参数固定
- 可学习提示：10个提示向量
- 轻量级分类头：2层MLP
- 参数效率：仅训练10-20%参数

**多维度评估**：
- 分类、聚类、稳定性、效率
- 4个标签比例对比实验

---

## 💻 系统要求

- **操作系统**：Linux (Ubuntu) 推荐
- **Python**：3.11+
- **硬件**：NVIDIA GPU with CUDA（推荐）
- **内存**：至少8GB RAM
- **存储**：约2GB（数据 + 模型 + 输出）

---

## 📦 主要依赖

- **PyTorch** >= 2.0.0 - 用于构建和训练所有深度学习模型
- **Scanpy** >= 1.9.0 - 用于单细胞数据的读取、预处理和分析
- **NumPy** >= 2.3.0 - 核心科学计算（注意：需要 >=2.3.0 以支持 np.load 对象数组特性）
- **Pandas** >= 1.3.0 - 数据处理
- **Scikit-learn** >= 1.0.0 - 机器学习评估指标计算（F1分数、ARI、NMI）和交叉验证
- **Captum** >= 0.6.0 - 实现集成梯度等模型可解释性方法
- **Matplotlib** >= 3.5.0 / **Seaborn** >= 0.12.0 - 数据和结果的可视化


